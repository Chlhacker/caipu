# 📦 data.json 数据同步指南

## ✅ 功能说明

现在应用支持通过 `data.json` 文件实现跨设备数据同步！

---

## 🔄 工作原理

### 数据加载优先级

```
1. 首次访问 → 尝试加载 data.json
2. 已有数据 → 从 localStorage 加载（用户修改的数据）
3. 无法加载 → 使用默认示例数据
```

### 数据流程图

```
┌─────────────────────────────────────┐
│  打开应用                           │
└─────────────┬───────────────────────┘
              │
              ▼
      ┌───────────────┐
      │localStorage有数据?│
      └───────┬───────┘
              │
      是 ┌────┴────┐ 否
         │         │
         ▼         ▼
    ┌────────┐ ┌──────────┐
    │加载本地 │ │加载data.json│
    │数据    │ └──────┬───┘
    └────────┘        │
         │            │
         └────┬───────┘
              ▼
      ┌───────────────┐
      │显示应用界面   │
      └───────────────┘
```

---

## 🚀 使用方法

### 方案 1：手动导出导入（推荐）

#### 设备 A（已有数据）
```
1. 打开应用
2. 点击右上角 "💾 数据" 按钮
3. 点击 "📥 导出所有数据"
4. 下载的文件重命名为 data.json
5. 替换项目根目录的 data.json 文件
6. Git 提交并推送
```

```bash
# Git 操作
git add data.json
git commit -m "更新菜品数据"
git push origin main
```

#### 设备 B（新设备）
```
1. Git 拉取最新代码
2. 打开应用（自动加载 data.json）
3. 数据已同步！✅
```

```bash
# Git 操作
git pull origin main
```

---

### 方案 2：自动更新 data.json（进阶）

如果你希望每次修改都自动更新 `data.json`，可以：

#### 1. 定期导出
- 每次添加/修改菜品后
- 点击 "💾 数据" → "📥 导出所有数据"
- 替换项目中的 `data.json`
- 提交到 Git

#### 2. 使用脚本（可选）
创建一个 `update-data.sh` 脚本（Linux/Mac）：

```bash
#!/bin/bash
# 从浏览器 localStorage 导出数据并更新 data.json
# 需要手动执行导出，然后运行此脚本

echo "请先在应用中导出数据，然后将下载的文件放到当前目录"
read -p "文件名（默认：caipu-data-*.json）: " filename

if [ -f "$filename" ]; then
    cp "$filename" data.json
    git add data.json
    git commit -m "更新菜品数据 $(date +%Y-%m-%d)"
    git push origin main
    echo "✅ 数据已更新并推送到 GitHub"
else
    echo "❌ 文件不存在"
fi
```

---

## 📊 data.json 文件格式

```json
{
  "version": "1.0",
  "lastUpdate": "2025-11-27",
  "dishes": [
    {
      "id": 1,
      "name": "番茄炒蛋",
      "category": "蔬菜",
      "image": "",
      "tags": ["家常", "简单"],
      "difficulty": "简单",
      "steps": "1. 鸡蛋打散\n2. 番茄切块\n3. 热锅炒蛋\n4. 加番茄翻炒"
    }
  ],
  "orders": [],
  "wishes": []
}
```

### 字段说明

- **version**: 数据格式版本
- **lastUpdate**: 最后更新日期
- **dishes**: 菜品数组
  - `id`: 唯一标识
  - `name`: 菜名
  - `category`: 分类
  - `image`: Base64 编码的图片（或空字符串）
  - `tags`: 标签数组
  - `difficulty`: 难度（简单/中等/困难）
  - `steps`: 制作步骤
- **orders**: 历史订单数组
- **wishes**: 心愿墙数组

---

## 🔧 常见场景

### 场景 1：新电脑首次使用

```
1. Git clone 项目
2. 打开 index.html
3. ✅ 自动加载 data.json 中的数据
4. 开始使用！
```

### 场景 2：多设备同步

**电脑 A 添加了新菜品**
```
1. 添加菜品
2. 导出数据 → data.json
3. Git push
```

**手机 B 同步数据**
```
1. Git pull
2. 清除浏览器缓存（或使用无痕模式）
3. 打开应用
4. ✅ 看到电脑 A 添加的菜品
```

### 场景 3：数据备份

```
1. 定期导出数据
2. 提交到 Git
3. GitHub 自动保存历史版本
4. 随时可以恢复到任意版本
```

---

## ⚠️ 注意事项

### 1. **localStorage 优先级更高**
- 如果浏览器已有数据，会优先使用 localStorage
- 要强制重新加载 data.json：
  ```
  方法 1：清除浏览器缓存
  方法 2：使用无痕模式
  方法 3：在控制台执行：
  localStorage.clear()
  location.reload()
  ```

### 2. **图片存储**
- 图片以 Base64 编码存储
- data.json 文件可能会很大
- Git 可能会提示文件过大
- 建议：定期清理不需要的图片

### 3. **数据冲突**
- 多设备同时修改可能冲突
- 建议：
  - 主要在一台设备编辑
  - 其他设备只查看
  - 或使用导入功能覆盖

### 4. **Git 忽略**
如果不想提交 data.json 到 Git：

```bash
# .gitignore
data.json
```

但这样就无法跨设备同步了。

---

## 🎯 最佳实践

### 推荐工作流程

```
1. 主设备（电脑）
   ├── 添加/编辑菜品
   ├── 导出数据
   ├── 替换 data.json
   └── Git push

2. 其他设备（手机）
   ├── Git pull
   ├── 清除缓存
   └── 刷新应用
```

### 数据备份策略

```
每周备份：
1. 导出数据
2. 重命名为 backup-YYYY-MM-DD.json
3. 保存到云盘或其他位置

每月整理：
1. 检查 data.json 大小
2. 清理不需要的图片
3. 清理已完成的订单
```

---

## 🐛 故障排查

### 问题 1：数据没有加载

**检查步骤**：
```
1. 打开浏览器开发者工具（F12）
2. 查看 Console 标签
3. 看是否有 "✅ 成功从 data.json 加载数据"
4. 如果没有，检查：
   - data.json 文件是否存在
   - 文件格式是否正确（JSON 格式）
   - localStorage 是否已有数据
```

### 问题 2：新设备看不到数据

**解决方案**：
```
1. 确认 Git pull 已拉取最新代码
2. 清除浏览器缓存：
   - Chrome: Ctrl+Shift+Delete
   - 选择 "全部时间"
   - 勾选 "缓存的图片和文件"
   - 清除数据
3. 刷新页面（Ctrl+F5）
```

### 问题 3：数据被覆盖

**恢复方法**：
```
1. 在数据弹窗中点击 "📂 选择文件导入"
2. 选择之前导出的备份文件
3. 确认导入
```

或者从 Git 历史恢复：
```bash
git log data.json  # 查看历史
git checkout <commit-id> data.json
```

---

## ✨ 优势总结

✅ **自动同步**：新设备自动加载数据  
✅ **Git 管理**：版本控制，随时回退  
✅ **跨设备**：所有设备共享同一数据源  
✅ **备份安全**：GitHub 云端备份  
✅ **灵活导入**：支持手动导入更新  

---

现在你可以在不同设备间轻松同步数据了！🎉
